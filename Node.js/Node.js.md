# Node.js 란?

Node.js는 Chrome V8 JavaScript 엔진으로 빌드 된 JavaScript 런타임이다.

- Node.js는 JavaScript를 서버에서도 사용할 수 있도록 만든 프로그램이다.
- Node.js는 V8이라는 JavaScript 엔진 위에서 동작하는 자바스크립트 런타임(환경)이다.
- Node.js는 서버사이트 스크립트 언어가 아니다. 프로그램(환경)이다.
- Node.js는 웹서버와 같이 확장성 있는 네트워크 프로그램을 제작하기 위해 만들어졌다.

내장 HTTP 서버 라이브러리를 포함하고 있어 웹 서버에서 별도 소프트웨어 없이 동작이 가능하다

## 역사

처음 출시 당시 js는 브라우저에 종속적인 언어였다

V8 엔진을 탑재한 크롬 브라우저가 출시되었고

V8이 오픈소스로 공개되자 Ryan Dahl이 V8을 기반으로 Node.js 개발을 시작한다.

## 특성

### 비동기 이벤트 주도

이벤트가 발생을 하게되면 지정한 어떤 작업이 수행되는 방식

멀티스레드 기반 동시성 모델 대신, 싱글 쓰레드를 효율적으로 사용할 수 있는 이벤트 루프 방식이다

## 이벤트 루프

![event-loop](/img/event-loop.png)

위에서 부터 한 단계씩 실행이 진행되고, 각 단계는 실행할 콜백들을 가진 큐와 비슷한 구조로 이루어져 있다.

각 단계들 마다 특정 시간을 할당하여 그 시간만큼 작업을 수행하는 라운드 로빈 방식으로 순환한여 지속적으로 요청을 처리할 수 있도록 동작한다.

close 단계에 도달 후 다시 timers 단계로 돌아가서 프로그램이 종료될 때 까지, 이 이벤트 루프를 반복한다.

### tick

항상 각 단계에서 특정 시간을 모두 보낼 필요는 없고, 각 단계가 갖고 있던 콜백을 모두 실행해서 목록이 비는 경우, 다음 단계로 넘어가게 되는데 단계가 넘어가는걸 tick이라고 한다.

### Timers 단계

타이머 함수로 스케줄링 한 콜백들이 들어간다.

ex) setTimeout, setInterval

### Pending 단계

이전 루프에서 마무리 되지 못한 I/O 콜백들이 실행된다.

ex) 연결이 실패한 작업이 이에 대한 오류를 알려주기 위해 이 단계에서 실행되는 경우가 있다

### Idle, prepare 단계

Node.js 내부의 libuv 라는 공간에서 작업을 수행하고 내부에 사용되는 I/O를 폴링하기 전에 수행하는 사전 준비들이 이 단계에서 이루어진다.

내부적인 작업을 위해서만 이용이 되고 외부에 노출되지 않기 때문에 개발자가 이 단계의 작업을 지정해주는 경우는 거의 없다

### poll 단계

새로운 I/O 이벤트를 가져와서 실행한다.

파일을 읽고 쓰거나 네트워크와 통신하는 등 위 단계에서 올라간 콜백들을 제외한 대부분의 콜백들이 이 단계에서 처리된다.

### check 단계

Node API 중 하나인 setImmediate()로 스케줄링된 콜백들을 호출한다.

요청을 기다리면서 poll 단계에 머무르는 경우가 많은데 만약 poll 단계의 큐가 비어있고 유휴 상태 Idle이 되었을 때, setImmediate()로 스케줄링된 콜백이 존재한다면 바로 check 단계로 넘어온다.

### close 단계

소켓 종료와 같은 일부 close 콜백들이 실행된다.

### 브라우저 이벤트 루프 vs Node.js 이벤트 루프

차이점이 꽤 존재하나 근본적인 동작 방식은 브라우저의 이벤트 루프와 같다

## 논 블로킹 I/O 모델

싱글 스레드로서 한번에 하나의 작업만 가능하다.

블로킹 모델 사용시 어떤 작업이 완료전까지 다른 작업들이 블로킹이 되어 실행되지 않는다. 작업이 완료되는 동안 자원을 100% 활용하지 못하고 작업이 완료되기를 기다리면 비효율적이다

싱글 쓰레드 언어인 자바스크립트의 특성을 고려하고 확장성 있는 네트워크 애플리케이션을 만들 수 있도록 이벤트 주도 방식과 논 블로킹 방식을 선택한 것 이다.

## Node.js 내부 구조

![nodejs-structure](/img/nodejs-structure.png)

### libuv

Node에 포함되어서 각종 비동기 작업들을 포함해서 다양한 작업을 수행하는 c 기반의 라이브러리이다. 이벤트 루프가 이 라이브러리 내부에 구현되어 있다.

![libuv](/img/libuv.png)

네트워크 I/O와 파일 I/O 등 기본적인 I/O에 대한 API와 기타 작업을 위한 자체 쓰레드 풀을 담고 있다.

기본적으로 4개의 쓰레드를 쓰레드 풀에 할당하게 된다.

이벤트 루프에 던져진 비동기 작업들은 일반적으로 libuv 내부가 아닌 시스템 커널에서 수행된다. libuv 시스템과 일종의 인터페이스 역할을 한다.

시스템이 처리할 수 있는 작업은 모두 이 시스템에 위임해서 처리를 하게 된다.

그 외에는 쓰레드 풀에 할당되어 있는 쓰레드에서 작업을 하게 된다.

대표적으로 네트워크와 소켓 관련 작업은 시스템이 하고, 파일 입출력같은 경우 libuv가 직접 처리하고 있다.

## 비동기 동작 처리 과정

이벤트 루프의 poll 단계에 네트워크 I/O 작업이 들어온다.

네트워크 작업이므로 libuv는 들어온 작업을 인터페이스를 통해 시스템 커널로 위임한다.

위임한 작업이 완료되면 커널에서 이벤트 루프로 이 결과를 돌려준다.

이렇게 프로그램에서는 돌아온 값을 사용할 수 있게 된다.

이러한 위임 방식과 분리 덕분에 싱글 쓰레드 기반의 이벤트 루프도 다양한 비동기 작업을 동시에 효율적으로 사용 할 수 있다

## 정리

- Node.js는 V8 엔진의 등장과 함께 개발된 js 런타임 환경
- 비동기 이벤트 주도, 논-블로킹으로 효율적이고, 확장성 있는 네트워크 앱을 만들 수 있도록 설계
- libuv를 이용해 비동기 작업을 시스템 커널에 위임하며 동작
